<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Game</title>
    <link rel="stylesheet" href="./main.css" />
  </head>
  <body>
    <section id="arena">
      <div class="column"></div>
      <div class="column"></div>
    </section>
    <section id="indicator">
      <div class="column"></div>
      <div class="column"></div>
    </section>
    <section id="panel">
      <div class="column"></div>
      <div class="column"></div>
    </section>
    <p id="disclaimer">
      This is not an official pokemon game, this is only for educational
      proposes
    </p>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="utils.js"></script>
    <script src="state.js"></script>
    <script src="pokemon.js"></script>
    <script>
      (function () {
        let state;

        // Setup
        function setup() {
          const { pokemons = [] } = state;
          const arena = $("#arena");
          const columns = $(".column");

          pokemons.forEach((pokemon, index) => {
            const container = columns[index];
            const containers = choose(pokemon);

            if (index === 0) {
              $(container).append(containers);
            } else {
              $(container).append(containers.reverse());
            }

            const [bar] = $(container).find(".bar");
            const [health] = $(container).find(".health");

            pokemon._ui.bar = bar;
            pokemon._ui.health = health;
          });
        }

        function turn() {
          const { pokemons = [], position = 0 } = state;
          const attacked = (position + 1) % 2;
          const pokemon = pokemons[attacked];

          // Turn
          const { newHealth, newPercentage } = calculateStatus(
            pokemon.health.initial,
            pokemon.health.current,
            getRandomNumber(20)
          );
          const newBarColor = calculateBarColor(newPercentage);
          const previousBarColor = pokemon.health.bar;

          // Update State
          pokemon.health.current = newHealth;
          pokemon.health.bar = newBarColor;

          // Update UI
          $(pokemon._ui.bar)
            .attr("style", `width: ${newPercentage}%`)
            .removeClass(previousBarColor)
            .addClass(newBarColor);

          $(pokemon._ui.health).text(
            `${pokemon.health.current}/${pokemon.health.initial}`
          );

          // Animations
          const pokemonActive = $($("#arena .column")[position]).find("img");

          const dirLeft = position === 0 ? "+" : "-";
          const dirTop = position === 0 ? "-" : "+";
          $(pokemonActive).animate(
            {
              "margin-left": `${dirLeft}=100px`,
              "margin-top": `${dirTop}=50px`,
            },
            100
          );
          $(pokemonActive).animate(
            {
              "margin-left": `${dirTop}=100px`,
              "margin-top": `${dirLeft}=50px`,
            },
            100
          );

          const pokemonAttacked = $($("#arena .column")[attacked]).find("img");

          $(pokemonAttacked).animate({ "margin-left": "-=50px" }, 100);
          $(pokemonAttacked).animate({ "margin-left": "+=50px" }, 100);
          $(pokemonAttacked).animate({ "margin-left": "+=50px" }, 100);
          $(pokemonAttacked).animate({ "margin-left": "-=50px" }, 100);

          if (pokemon.health.current > 0) {
            state.position = (state.position + 1) % 2;
            render();
          } else {
            $("#panel .message").text("Wins!!!");
            $("#panel .moves button").attr("disabled", "");
          }
        }

        function render() {
          const { pokemons = [], position = 0 } = state;
          const pokemon = pokemons[position];

          const panel = $("#panel");

          const message = "What attack do you want to use?";
          const [dialogContainer, movesContainer] = controls(
            pokemon,
            message,
            turn
          );
          const [left, right] = $(panel).children();

          if (position === 0) {
            $(left).empty().append(dialogContainer);
            $(right).empty().append(movesContainer);
          } else {
            $(left).empty().append(movesContainer);
            $(right).empty().append(dialogContainer);
          }

          const indicator = $("#indicator");

          $(indicator)
            .find(".column")
            .each(function (index) {
              if (index === position) {
                $(this).html(`<div class="arrow"></div>`);
              } else {
                $(this).empty();
              }
            });
        }

        $(document).ready(async (event) => {
          // getState().then((data) => {
          //   state = data;
          //   setup();
          //   render();
          // });

          state = await getState();
          setup();
          render();
        });
      })();
    </script>
  </body>
</html>
